<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenFetcher | Intelligent Scraper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Mintlify-style Pulse Loader */
        .loader-line {
            height: 3px;
            width: 100%;
            background: rgba(56, 189, 248, 0.1);
            position: relative;
            overflow: hidden;
        }
        .loader-line::after {
            content: '';
            position: absolute;
            left: -150%;
            width: 150%;
            height: 100%;
            background: linear-gradient(90deg, transparent, #38bdf8, transparent);
            animation: slide 1.5s infinite linear;
        }
        @keyframes slide {
            0% { left: -150%; }
            100% { left: 100%; }
        }
        
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-300 min-h-screen">
    <div id="loader" class="hidden loader-line fixed top-0 left-0 z-50"></div>

    <div class="max-w-7xl mx-auto p-6 lg:p-10 space-y-8">
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-slate-800 pb-8">
            <div>
                <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                    <span class="bg-sky-500 p-2 rounded-lg text-white text-sm"><i class="fas fa-water"></i></span>
                    OpenFetcher Engine
                </h1>
                <p class="text-slate-500 mt-2">Intelligent markdown extraction with real-time telemetry.</p>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <input type="text" id="urlInput" placeholder="https://supermemory.ai" 
                       class="flex-1 md:w-80 bg-slate-900 border border-slate-700 p-3 rounded-xl focus:ring-2 focus:ring-sky-500 outline-none text-white">
                <button onclick="startScrape()" id="btn"
                        class="bg-sky-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-sky-500 transition active:scale-95 disabled:opacity-50">
                    Scrape
                </button>
            </div>
        </header>

        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-4 space-y-4">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 h-[650px] flex flex-col">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 flex justify-between">
                        Execution Log <span id="logCount" class="text-sky-500">0 pages</span>
                    </h3>
                    <div id="logList" class="flex-1 overflow-y-auto space-y-2 pr-2">
                        <p class="text-slate-600 italic text-sm">Waiting for task...</p>
                    </div>
                </div>
            </div>

            <div class="col-span-12 lg:col-span-8 space-y-6">
                <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 h-[650px] flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex gap-4">
                            <button onclick="switchTab('visual')" id="tabVisual" class="text-sky-400 border-b-2 border-sky-400 pb-1 text-sm font-medium">Visual Render</button>
                            <button onclick="switchTab('json')" id="tabJson" class="text-slate-500 hover:text-slate-300 pb-1 text-sm font-medium">Raw JSON</button>
                        </div>
                        <button onclick="copyRawJson()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg transition">
                            <i class="far fa-copy mr-2"></i>Export Data
                        </button>
                    </div>

                    <div id="visualView" class="flex-1 overflow-y-auto prose prose-invert max-w-none prose-img:rounded-xl">
                        <p class="text-slate-600 italic">No content rendered.</p>
                    </div>

                    <pre id="jsonView" class="hidden flex-1 overflow-y-auto bg-slate-950 p-4 rounded-xl text-[10px] text-emerald-400 font-mono"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = "https://openfetcher.onrender.com/scrape"; 
        let rawDataStore = [];
        let startTime;

        function switchTab(tab) {
            const visual = document.getElementById('visualView');
            const json = document.getElementById('jsonView');
            const tVis = document.getElementById('tabVisual');
            const tJS = document.getElementById('tabJson');

            if (tab === 'visual') {
                visual.classList.remove('hidden');
                json.classList.add('hidden');
                tVis.className = "text-sky-400 border-b-2 border-sky-400 pb-1 text-sm font-medium";
                tJS.className = "text-slate-500 hover:text-slate-300 pb-1 text-sm font-medium";
            } else {
                json.classList.remove('hidden');
                visual.classList.add('hidden');
                tJS.className = "text-sky-400 border-b-2 border-sky-400 pb-1 text-sm font-medium";
                tVis.className = "text-slate-500 hover:text-slate-300 pb-1 text-sm font-medium";
            }
        }

        async function startScrape() {
            const url = document.getElementById('urlInput').value;
            const logList = document.getElementById('logList');
            const visual = document.getElementById('visualView');
            const json = document.getElementById('jsonView');
            const loader = document.getElementById('loader');
            const btn = document.getElementById('btn');

            if (!url) return;

            // Reset UI
            logList.innerHTML = "";
            visual.innerHTML = "<p class='animate-pulse text-sky-500'>Synthesizing data blocks...</p>";
            json.innerText = "";
            rawDataStore = [];
            loader.classList.remove('hidden');
            btn.disabled = true;
            startTime = performance.now();

            try {
                const response = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, site_id: "demo_user" })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedMarkdown = "";

                while (true) {
                    const pageStart = performance.now();
                    const { done, value } = await reader.read();
                    if (done) break;

                    const lines = decoder.decode(value).split('\n');
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            const pageEnd = performance.now();
                            const duration = ((pageEnd - pageStart) / 1000).toFixed(2);
                            
                            rawDataStore.push(data);
                            document.getElementById('logCount').innerText = `${rawDataStore.length} pages`;

                            // Add Log Entry with Time
                            const logEntry = document.createElement('div');
                            logEntry.className = "bg-slate-950/50 border border-slate-800 p-3 rounded-lg flex justify-between items-center animate-in fade-in slide-in-from-left-2";
                            logEntry.innerHTML = `
                                <span class="text-[11px] truncate text-slate-400 w-3/4">${data.url}</span>
                                <span class="text-[10px] text-sky-500 font-mono">${duration}s</span>
                            `;
                            logList.prepend(logEntry);

                            // Update Content
                            accumulatedMarkdown += `\n\n# ${data.url}\n` + data.markdown;
                            visual.innerHTML = marked.parse(accumulatedMarkdown);
                            json.innerText = JSON.stringify(rawDataStore, null, 2);
                        } catch (e) {}
                    }
                }
            } catch (err) {
                logList.innerHTML = `<div class="text-red-400">Connection Failed</div>`;
            } finally {
                const totalTime = ((performance.now() - startTime) / 1000).toFixed(1);
                loader.classList.add('hidden');
                btn.disabled = false;
                logList.innerHTML = `<div class="text-[10px] text-emerald-400 mb-4 tracking-tighter uppercase font-bold">Successfully completed in ${totalTime}s</div>` + logList.innerHTML;
            }
        }

        async function copyRawJson() {
            await navigator.clipboard.writeText(JSON.stringify(rawDataStore, null, 2));
            alert("Exported JSON to clipboard!");
        }
    </script>
</body>
</html>